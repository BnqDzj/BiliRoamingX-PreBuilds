# This workflow will install Python dependencies, run tests and lint with a single version of Python
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-python-with-github-actions

name: BiliRoamingX PreBuilds

on:
  workflow_dispatch:
    inputs:
      UseSource:
        description: 'Use Source code'
        type: boolean
        default: false
        required: true
  repository_dispatch:
    types: [BiliRoamingX-PreBuilds]


jobs:
  BiliRoamingX-Releases-PreBuilds:
    name: BiliRoamingX Releases PreBuilds
    if: ${{ github.event.inputs.UseSource != 'true' }}
    runs-on: ubuntu-latest

    steps:
      - name: Free Disk-Space
        run: |
          df -h
          docker rmi `docker images -q`
          docker system prune -a -f
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /etc/mysql /etc/php
          sudo -E apt-get -y purge azure-cli* docker* ghc* zulu* hhvm* llvm* firefox* google* dotnet* aspnetcore* powershell* openjdk* adoptopenjdk* mysql* php* mongodb* moby* snap* || true
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install libfuse-dev $(curl -fsSL git.io/depends-ubuntu-2204)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo mkdir -p /mnt/Downloads/
          sudo chown $USER:$GROUPS /mnt/Downloads/
          df -h

      - name: Checkout
        uses: actions/checkout@main
  
      - name: Set up Python
        uses: actions/setup-python@main
        with:
          python-version: 3.13
          check-latest: true
          allow-prereleases: true
  
      - name: Set up requests
        run: |
          pip install requests
  
      - name: run Releases-PreBuilds.py
        env:
          Folder_Path: /mnt/Downloads/
          PAT: ${{secrets.PAT}}
        run: |
          python Releases-PreBuilds.py
  
      - name: Set up Java
        uses: actions/setup-java@main
        with:
          distribution: 'temurin' # See 'Supported distributions' for available options
          java-version: '21'
          check-latest: true

      - name: Run ReVanced CLI
        run: |
          cd /mnt/Downloads/
          java -jar /mnt/Downloads/revanced-cli.jar patch --merge /mnt/Downloads/integrations.apk --patch-bundle /mnt/Downloads/patches.jar --signing-levels 1,2,3 /mnt/Downloads/BiliBili.apk
          rm -rf /mnt/Downloads/*temporary-files

      - name: Upload artifact
        uses: actions/upload-artifact@main
        with:
          name: BiliRoamingX PreBuilds
          path: /mnt/Downloads/

      - name: Create Release and Upload Release Asset
        uses: ncipollo/release-action@main
        with:
          artifacts: |
            /mnt/Downloads/*patched*
          name: "Latest Releases"
          body: "Latest Releases"
          tag: "Latest Releases"
          allowUpdates: true
          artifactErrorsFailBuild: true
          prerelease: false
          token: ${{ secrets.PAT }}
  
      - name: Delete old workflow run using Personal Token
        uses: Mattraks/delete-workflow-runs@main
        with:
          token: ${{ secrets.PAT }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 0

  BiliRoamingX-Source-PreBuilds:
    name: BiliRoamingX Source PreBuilds
    if: ${{ github.event.inputs.UseSource == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - name: Free Disk-Space
        run: |
          df -h
          docker rmi `docker images -q`
          docker system prune -a -f
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /etc/mysql /etc/php
          sudo -E apt-get -y purge azure-cli* docker* ghc* zulu* hhvm* llvm* firefox* google* dotnet* aspnetcore* powershell* openjdk* adoptopenjdk* mysql* php* mongodb* moby* snap* || true
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install libfuse-dev $(curl -fsSL git.io/depends-ubuntu-2204)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo mkdir -p /Downloads
          sudo chown $USER:$GROUPS /Downloads
          df -h

      - name: Checkout
        uses: actions/checkout@main
  
      - name: Set up Python
        uses: actions/setup-python@main
        with:
          python-version: 3.13
          check-latest: true
          allow-prereleases: true
  
      - name: Set up requests
        run: |
          pip install requests
  
      - name: run Source-PreBuilds.py
        env:
          Folder_Path: /mnt/Downloads/
          PAT: ${{secrets.PAT}}
        run: |
          python Source-PreBuilds.py
  
      - name: Set up Java
        uses: actions/setup-java@main
        with:
          distribution: 'temurin' # See 'Supported distributions' for available options
          java-version: '21'
          check-latest: true

      - name: Cache gradle
        uses: actions/cache@main
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'gradle/*.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Retrieve version
        run: |
          cd /mnt/Downloads/
          git clone --recurse-submodules https://github.com/BiliRoamingX/BiliRoamingX.git
          cd BiliRoamingX
          version=`awk -F "=" '$1 == "version" {print $2}' gradle.properties`
          commit_count=`git rev-list HEAD --count`
          version="${version}.r${commit_count}"
          echo "VERSION=$version" >> $GITHUB_ENV

      - name: Build BiliRoamingX
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          cd /mnt/Downloads/BiliRoamingX/
          ./gradlew --no-daemon -Dorg.gradle.jvmargs=-Xmx2g -Pversion=$VERSION dist
          mv /mnt/Downloads/BiliRoamingX/build/*integrations*.apk /mnt/Downloads/integrations.apk
          mv /mnt/Downloads/BiliRoamingX/build/*patches*.jar /mnt/Downloads/patches.jar

      - name: Run ReVanced CLI
        run: |
          cd /mnt/Downloads/
          java -jar /mnt/Downloads/revanced-cli.jar patch --merge /mnt/Downloads/integrations.apk --patch-bundle /mnt/Downloads/patches.jar --signing-levels 1,2,3 /mnt/Downloads/BiliBili.apk
          rm -rf /mnt/Downloads/*temporary-files

      - name: Upload artifact
        uses: actions/upload-artifact@main
        with:
          name: BiliRoamingX PreBuilds
          path: /mnt/Downloads/

      - name: Create Release and Upload Release Asset
        uses: ncipollo/release-action@main
        with:
          artifacts: |
            /mnt/Downloads/*patched*
          name: "Latest Source"
          body: "Latest Source"
          tag: "Latest Source"
          allowUpdates: true
          artifactErrorsFailBuild: true
          prerelease: false
          token: ${{ secrets.PAT }}
  
      - name: Delete old workflow run using Personal Token
        uses: Mattraks/delete-workflow-runs@main
        with:
          token: ${{ secrets.PAT }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 0
